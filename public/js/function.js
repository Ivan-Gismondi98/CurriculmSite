// Laravel copy of function.js with minor tweak for avatar selector
var adfly_id = 23478769; var adfly_advert = 'int'; var frequency_cap = 5; var frequency_delay = 5; var init_delay = 15; var popunder = false;
function toggleNavigation(){const nav=document.getElementById('mobile-nav'); if(nav) nav.classList.toggle('w3-show');}
function generatePDF(){const originalBody=document.body.innerHTML; document.body.classList.add('pdf-mode'); const pdfContainer=document.createElement('div'); pdfContainer.className='pdf-container pdf-modern'; const header=document.createElement('header'); header.className='pdf-header';
  // Be robust: match avatar in Laravel public path or plain filename
  const avatarImg=document.querySelector('img[src$="avatar.png"], .image-section img');
  if(avatarImg){ const av=avatarImg.cloneNode(true); av.classList.add('pdf-avatar'); header.appendChild(av); }
  const titleWrap=document.createElement('div'); titleWrap.className='pdf-title-block'; const roleHeading=document.querySelector('#home h2'); const roleText=roleHeading?roleHeading.textContent.trim():'Mid-Level .NET Developer'; titleWrap.innerHTML='<h1>Ivan Gismondi</h1><h2>'+roleText+'</h2>'; header.appendChild(titleWrap); pdfContainer.appendChild(header);
  const downloadBtn=document.querySelector('button[onclick="generatePDF()"]'); if(downloadBtn){ downloadBtn.innerHTML='<i data-feather="loader" style="vertical-align:-0.35em;"></i><span class="w3-margin-left download-text">GENERANDO PDF...</span>'; downloadBtn.disabled=true; if(window.feather) feather.replace(); }
  function addSection(id,customTitle){ const src=document.getElementById(id); if(!src) return; const block=document.createElement('section'); block.className='pdf-section'; const hTitle=document.createElement('h3'); hTitle.textContent=customTitle||id.toUpperCase(); block.appendChild(hTitle); const clone=src.cloneNode(true); clone.querySelectorAll('[class*="margin-top-20-percent"]').forEach(e=>e.classList.remove('w3-margin-top-20-percent')); clone.querySelectorAll('h1,h2').forEach(h=>h.remove()); Array.from(clone.children).forEach(ch=>{ if(ch.tagName && !/SCRIPT|STYLE/.test(ch.tagName)){ block.appendChild(ch); } }); pdfContainer.appendChild(block); }
  addSection('about','Profilo'); const resume=document.getElementById('resume'); if(resume){ const expWrapper=resume.querySelector('div.w3-container'); if(expWrapper){ const expSection=document.createElement('section'); expSection.className='pdf-section exp-section'; expSection.innerHTML='<h3>Esperienze Professionali</h3>'; expWrapper.querySelectorAll('div').forEach(exp=>{ if(exp.querySelector('h5')){ const cloned=exp.cloneNode(true); cloned.classList.add('experience-item'); expSection.appendChild(cloned); } }); pdfContainer.appendChild(expSection); }
    const formCompSection=document.createElement('section'); formCompSection.className='pdf-section'; formCompSection.innerHTML='<h3>Formazione & Competenze</h3>'; const siblings=[...resume.children].filter(ch=>ch!==expWrapper); siblings.forEach(block=>{ const firstH2=block.querySelector('h2'); let headingText=''; if(firstH2){ headingText=firstH2.textContent.replace(/[:\s]+$/,'').trim(); firstH2.remove(); } const sub=document.createElement('div'); sub.className='subgroup no-break'; if(headingText){ const h4=document.createElement('h4'); h4.textContent=headingText; sub.appendChild(h4); } [...block.children].forEach(child=>{ if(child.tagName && !/H2/.test(child.tagName)) sub.appendChild(child.cloneNode(true)); }); formCompSection.appendChild(sub); }); formCompSection.querySelectorAll('h4').forEach(h=>{ const label=h.textContent.toLowerCase(); if(label.includes('soft')){ const ul=h.nextElementSibling; if(ul && ul.tagName==='UL'){ const chips=document.createElement('div'); chips.className='skill-chips'; ul.querySelectorAll('li').forEach(li=>{ const span=document.createElement('span'); span.className='skill-chip soft'; span.textContent=li.textContent.trim(); chips.appendChild(span); }); ul.remove(); h.after(chips); } } else if(label.includes('technical')){ const ul=h.nextElementSibling; if(ul && ul.tagName==='UL'){ const chips=document.createElement('div'); chips.className='skill-chips'; ul.querySelectorAll('li').forEach(li=>{ const span=document.createElement('span'); span.className='skill-chip tech'; span.textContent=li.textContent.trim(); chips.appendChild(span); }); ul.remove(); h.after(chips); } } }); formCompSection.querySelectorAll('.subgroup').forEach(sub=>{ const mainHeader=sub.querySelector('h4'); if(mainHeader && /lingue/i.test(mainHeader.textContent)){ const languageHeaders=[...sub.querySelectorAll('h4')].filter(h=>h!==mainHeader); if(languageHeaders.length){ const chips=document.createElement('div'); chips.className='skill-chips'; languageHeaders.forEach(h=>{ let levelEl=h.nextElementSibling; let levelText=''; if(levelEl && levelEl.tagName==='P'){ levelText=levelEl.textContent.trim(); let extraEl=levelEl.nextElementSibling; if(extraEl && extraEl.tagName==='P' && extraEl.previousElementSibling===levelEl && !/^\s*$/.test(extraEl.textContent)){ levelText+=' – '+extraEl.textContent.trim(); extraEl.remove(); } levelEl.remove(); } const chip=document.createElement('span'); chip.className='skill-chip lang'; chip.textContent= levelText ? (h.textContent.trim()+' – '+levelText) : h.textContent.trim(); chips.appendChild(chip); h.remove(); }); mainHeader.after(chips); } } }); const purgeStray=root=>{ [...root.childNodes].forEach(n=>{ if(n.nodeType===3){ const t=n.textContent.replace(/\s+/g,''); if(t.length===0 || /^[.:;-]$/.test(t)) n.remove(); } else if(n.nodeType===1){ if(!n.firstElementChild && n.textContent.trim()==='') n.remove(); } }); }; purgeStray(formCompSection); formCompSection.querySelectorAll('.subgroup').forEach(s=>purgeStray(s)); pdfContainer.appendChild(formCompSection); }
  addSection('contact','Contatti'); pdfContainer.querySelectorAll('.pdf-section').forEach(sec=>{ const txt=sec.textContent.replace(/\s+/g,'').trim(); if(txt.length<5) sec.remove(); }); const disclaimer=document.createElement('div'); disclaimer.className='pdf-footer-note'; disclaimer.textContent="Autorizzo il trattamento dei miei dati personali ai sensi del D.Lgs. 196/2003 e del Regolamento (UE) 2016/679 (GDPR). Le offerte si intendono rivolte a persone di entrambi i sessi (L. 903/77)."; pdfContainer.appendChild(disclaimer); document.body.innerHTML=''; document.body.appendChild(pdfContainer);
  const opt={ margin:[0.30,0.25,0.60,0.25], filename:'Ivan_Gismondi_CV.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{ scale:2, useCORS:true, backgroundColor:'#ffffff', scrollX:0, scrollY:0 }, jsPDF:{ unit:'in', format:'a4', orientation:'portrait' }, pagebreak:{ mode:['css'], avoid:['.pdf-header','.pdf-title-block','h1','h2','h3','h4','h5','.experience-item','.subgroup'] } };
  html2pdf().set(opt).from(pdfContainer).toPdf().get('pdf').then(pdf=>{ const total=pdf.internal.getNumberOfPages(); for(let i=1;i<=total;i++){ pdf.setPage(i); pdf.setFontSize(9); pdf.setTextColor(110); const w=pdf.internal.pageSize.getWidth(); const h=pdf.internal.pageSize.getHeight(); pdf.text(`Page ${i} / ${total}`, w-1.2, h-0.28, {align:'right'}); } }).save().then(()=>{ document.body.innerHTML=originalBody; document.body.classList.remove('pdf-mode'); if(downloadBtn){ downloadBtn.innerHTML='<i data-feather="arrow-down" style="vertical-align:-0.35em;"></i><span class="w3-margin-left download-text">DOWNLOAD CV</span>'; downloadBtn.disabled=false; } if(typeof setAgeInHeading==='function') setAgeInHeading(); if(window.feather) feather.replace(); }).catch(err=>{ console.error('Error generating PDF:',err); document.body.innerHTML=originalBody; document.body.classList.remove('pdf-mode'); if(downloadBtn){ downloadBtn.innerHTML='<i data-feather\"alert-triangle\" style=\"vertical-align:-0.35em;\"></i><span class=\"w3-margin-left download-text\">ERRORE</span>'; downloadBtn.disabled=false; } if(typeof setAgeInHeading==='function') setAgeInHeading(); if(window.feather) feather.replace(); }); }
function computeAge(){ const birth=new Date(1998,5,11); const today=new Date(); let age=today.getFullYear()-birth.getFullYear(); const m=today.getMonth()-birth.getMonth(); if(m<0 || (m===0 && today.getDate()<birth.getDate())) age--; return age; }
function setAgeInHeading(){ const h1=document.querySelector('#home h1'); if(!h1) return; const nameOnly=h1.textContent.replace(/\s*\(.*?\)\s*$/,'').trim(); const age=computeAge(); h1.textContent=`${nameOnly} (${age})`; }
let isTranslated=false; let originalHTML=null; function getTranslationRoot(){return document.querySelector('section[lang="it"]')||document.body;} function saveOriginalContent(){const root=getTranslationRoot(); originalHTML=root.innerHTML;} function restoreOriginalContent(){if(originalHTML!=null){const root=getTranslationRoot(); root.innerHTML=originalHTML;}} function normalizeApostrophes(str){return str.replace(/’/g,"'");} function normalizeWhitespace(str){return str.replace(/\s+/g,' ').trim();} function normalizeKey(str){return normalizeWhitespace(normalizeApostrophes(str));}
const REMOTE_TRANSLATION={ enabled:false, timeoutMs:8000, providers:[ {type:'libre', baseUrl:'https://libretranslate.com'}, {type:'libre', baseUrl:'https://translate.astian.org'}, {type:'mymemory'} ]};
const translations={ 'DESCRIZIONE:':'ABOUT:', 'ESPERIENZE:':'EXPERIENCE:', 'ISTRUZIONE:':'EDUCATION:', 'COMPETENZE:':'SKILLS:', 'LINGUE:':'LANGUAGES:', 'PATENTI:':'LICENSES:', 'HOBBIES:':'HOBBIES:', 'CONTATTAMI':'CONTACT ME', 'DOWNLOAD CV':'DOWNLOAD CV', 'I MIEI PROGETTI':'MY PROJECTS', 'TRADUCI PAGINA':'TRANSLATE PAGE', 'GENERANDO PDF...':'GENERATING PDF...', 'TRADUCENDO...':'TRANSLATING...', 'VERSIONE ORIGINALE':'ORIGINAL VERSION', 'DESCRIZIONE':'ABOUT', 'ESPERIENZE':'RESUME', 'Soft skills':'Soft Skills', 'Technical skills':'Technical Skills', 'Prime installazioni su PSN o server cliente: provisioning iniziale del database, gestione domini e certificati SSL (Aruba), configurazione IIS (siti, binding, porte) e pubblicazione/hardening della webapp; diagnostica di rete con strumenti come telnet, nslookup e tracert per verifica connettività e apertura porte.':'Initial deployments on PSN or customer servers: initial database provisioning, domain and SSL certificate (Aruba) management, IIS configuration (sites, bindings, ports) and web app publishing/hardening; network diagnostics with tools such as telnet, nslookup, and tracert to verify connectivity and open ports.' };
const phraseMap={ 'Progettazione e implementazione':'Design and implementation', 'integrazioni software':'software integrations', 'cartelle cliniche':'medical records', 'dispositivi medicali':'medical devices', 'garantendo interoperabilità sicura e conforme agli standard sanitari':'ensuring secure interoperability and compliance with health standards', 'Sviluppo e manutenzione di web app':'Development and maintenance of web apps', 'e app mobile':'and mobile apps', 'nuove funzionalità':'new features', 'risoluzione bug':'bug resolution', 'aggiornamenti evolutivi':'evolutionary updates', 'Integrazione di moduli basati su Intelligenza Artificiale':'Integration of modules based on Artificial Intelligence', 'supporto decisionale':'decision support', 'ambito medico':'medical field', 'utilizzando':'using', 'servizi REST':'REST services', 'Prime installazioni su PSN o server cliente':'Initial deployments on PSN or customer servers', 'provisioning iniziale del database':'initial database provisioning', 'gestione domini e certificati SSL':'domain and SSL certificate management', 'configurazione IIS':'IIS configuration', 'siti, binding, porte':'sites, bindings, ports', 'pubblicazione':'publishing', 'hardening della webapp':'hardening of the web app', 'diagnostica di rete':'network diagnostics', 'strumenti come':'tools such as', 'per verifica connettività e apertura porte':'to verify connectivity and open ports', 'Sviluppo di applicazioni mobili multipiattaforma':'Development of cross-platform mobile applications', 'con particolare attenzione all’integrazione con hardware e sensori':'with a focus on integration with hardware and sensors', 'per applicazioni sanitarie':'for healthcare applications', 'Gestione di database cloud e API REST':'Management of cloud databases and REST APIs', 'comunicazione fluida tra applicazioni e sistemi esterni':'fluid communication between applications and external systems', 'Utilizzo di tecnologie avanzate':'Use of advanced technologies', 'con competenze in Git e strumenti di supporto remoto':'with Git skills and remote support tools', 'Responsabile di deploy e manutenzione server presso clienti':'Responsible for deploying and maintaining servers at customers', 'inclusa la pubblicazione delle app su Google Play Store e Apple App Store':'including publishing apps on the Google Play Store and Apple App Store', 'Esperienze Professionali':'Professional Experience', 'Sviluppatore freelance':'Freelance Developer', 'Gestione delle relazioni con i clienti':'Customer relationship management', 'Rafforzamento competenze in':'Strengthening skills in', 'Interazione con aziende di rilievo nazionale':'Interaction with leading national companies', 'Gestione del sito web e delle piattaforme social':'Website and social platform management', 'Creazione contenuti digitali e ottimizzazione della presenza online':'Creation of digital content and optimization of online presence', 'Riparazione di computer e manutenzione stampanti':'Repair of computers and printer maintenance', 'Sviluppo web di base':'Basic web development', 'Apprendimento di Nuovi Linguaggi di Programmazione':'Learning New Programming Languages', 'Problem Solving e Analisi Creativa':'Problem Solving and Creative Analysis', 'Lettura di Libri e Articoli su Tecnologia e Innovazione':'Reading Books and Articles on Technology and Innovation', ' Gen ':' Jan ', ' Feb ':' Feb ', ' Mar ':' Mar ', ' Apr ':' Apr ', ' Mag ':' May ', ' Giu ':' Jun ', ' Lug ':' Jul ', ' Ago ':' Aug ', ' Set ':' Sep ', ' Ott ':' Oct ', ' Nov ':' Nov ', ' Dic ':' Dec ', ' in corso':' ongoing', ' Ingegneria Informatica':' Computer Engineering', ' Corsista in Digital Marketing':' Trainee in Digital Marketing'};
function translateByPhrases(text){ let out=text; let changed=false; for(const [it,en] of Object.entries(phraseMap)){ const re=new RegExp(it.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'); if(re.test(out)){ out=out.replace(re,en); changed=true; } } return changed? out : text; }
function replaceFromSources(text){ let out=text; let changed=false; const sources=[window.TRANSLATION_MAP||{}, translations]; for(const src of sources){ if(!src) continue; const entries=Object.entries(src).sort((a,b)=>(b[0]?.length||0)-(a[0]?.length||0)); for(const [it,en] of entries){ if(!it || typeof it!== 'string' || it.length<3) continue; if(out.includes(it)){ out=out.split(it).join(en); changed=true; } } } return changed? out : text; }
function replaceFromNormalizedMap(text){ const normText=normalizeKey(text); const map=buildLocalMap(); const keys=Object.keys(map).sort((a,b)=>(b.length||0)-(a.length||0)); let result=normText; let changed=false; for(const k of keys){ if(!k || k.length<3) continue; const v=map[k]; const re=new RegExp(k.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'); if(re.test(result)){ result=result.replace(re,v); changed=true; } } return changed ? result : text; }
const cacheTrans={}; const PERSIST_KEY='translationCache'; function loadPersistentCache(){ try{ const raw=localStorage.getItem(PERSIST_KEY); if(raw){ const obj=JSON.parse(raw); if(obj&&typeof obj==='object'){ Object.assign(cacheTrans,obj); } } }catch(e){ console.warn('Failed to load persistent cache',e); } } let saveTimeout=null; function scheduleCacheSave(){ clearTimeout(saveTimeout); saveTimeout=setTimeout(()=>{ try{ localStorage.setItem(PERSIST_KEY, JSON.stringify(cacheTrans)); }catch(e){ console.warn('Failed to persist cache', e); } },500); }
let __LOCAL_NORM=null; function buildLocalMap(){ if(__LOCAL_NORM) return __LOCAL_NORM; __LOCAL_NORM={}; const external=(window.TRANSLATION_MAP||{}); for(const [k,v] of Object.entries(external)){ __LOCAL_NORM[normalizeKey(k)]=v; } return __LOCAL_NORM; }
function fetchWithTimeout(url, options, timeoutMs){ const controller=new AbortController(); const id=setTimeout(()=>controller.abort(), timeoutMs); return fetch(url, { ...options, signal: controller.signal }).finally(()=>clearTimeout(id)); }
async function translateWithLibre(text, baseUrl){ try{ const res=await fetchWithTimeout(`${baseUrl.replace(/\/$/,'')}/translate`, { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body:JSON.stringify({ q:text, source:'it', target:'en', format:'text' }) }, REMOTE_TRANSLATION.timeoutMs); if(!res.ok) return null; const json=await res.json(); const out=json.translatedText||json.translation||null; if(typeof out==='string' && out.trim()) return out; return null; }catch(e){ return null; } }
async function translateWithMyMemory(text){ try{ const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=it|en`; const res=await fetchWithTimeout(url, { headers:{'Accept':'application/json'} }, REMOTE_TRANSLATION.timeoutMs); if(!res.ok) return null; const json=await res.json(); const out=json && json.responseData && json.responseData.translatedText; if(typeof out==='string' && out.trim()) return out; return null; }catch(e){ return null; } }
async function translateRemote(text){ if(!REMOTE_TRANSLATION.enabled) return null; for(const prov of REMOTE_TRANSLATION.providers){ let result=null; if(prov.type==='libre') result=await translateWithLibre(text, prov.baseUrl); else if(prov.type==='mymemory') result=await translateWithMyMemory(text); if(result && typeof result==='string' && result.trim()) return result.trim(); } return null; }
async function translateViaProviders(pieceNorm){ const map=buildLocalMap(); if(map[pieceNorm]) return map[pieceNorm]; if(cacheTrans[pieceNorm] && cacheTrans[pieceNorm]!==pieceNorm) return cacheTrans[pieceNorm]; return pieceNorm; }
async function fetchTranslation(text){ const plain=text.trim(); if(!plain) return text; const key=normalizeKey(plain); const map=buildLocalMap(); const hit=map[key]; return hit? hit: text; }
function collectTextNodes(root){ const nodes=[]; if(!root) return nodes; const walker=document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false); while(walker.nextNode()){ const n=walker.currentNode; const t=n.nodeValue; if(!t) continue; const parent=n.parentNode; if(parent && (parent.nodeName==='SCRIPT' || parent.nodeName==='STYLE')) continue; const trimmed=t.trim(); if(trimmed.length===0) continue; nodes.push(n); } return nodes; }
async function translateNodesParallel(textNodes, concurrency=1){ let index=0; async function worker(){ while(index<textNodes.length){ const i=index++; const node=textNodes[i]; const original=node.nodeValue; const translated=await fetchTranslation(original); if(translated && translated!==original){ node.nodeValue=translated; } } } const workers=[]; const total=Math.min(concurrency, textNodes.length); for(let w=0; w<total; w++) workers.push(worker()); await Promise.all(workers); }
function collectAttributePairs(root){ const pairs=[]; if(!root) return pairs; const ATTRS=['title','alt','placeholder','aria-label']; const all=root.querySelectorAll('*'); all.forEach(el=>{ for(const a of ATTRS){ if(el.hasAttribute && el.hasAttribute(a)){ const val=el.getAttribute(a); if(val && val.trim()) pairs.push({el, attr:a, value:val}); } } const tag=el.tagName; if((tag==='INPUT'||tag==='BUTTON'||tag==='TEXTAREA') && el.hasAttribute && el.hasAttribute('value')){ const val=el.getAttribute('value'); if(val && val.trim()) pairs.push({el, attr:'value', value:val}); } }); return pairs; }
async function translateAttributesParallel(pairs, concurrency=6){ let index=0; async function worker(){ while(index<pairs.length){ const i=index++; const {el, attr, value}=pairs[i]; const translated=await fetchTranslation(value); if(translated && translated!==value){ try{ el.setAttribute(attr, translated); }catch(e){} } } } const workers=[]; const total=Math.min(concurrency, pairs.length); for(let w=0; w<total; w++) workers.push(worker()); await Promise.all(workers); }
async function translateDocumentTitle(){ try{ const t=document.title||''; if(!t) return; const tr=await fetchTranslation(t); if(tr && tr!==t) document.title=tr; }catch(e){} }
async function translateToEnglish(){ const root=getTranslationRoot(); const nodes=collectTextNodes(root); const attrPairs=collectAttributePairs(root); await Promise.all([ translateNodesParallel(nodes,6), translateAttributesParallel(attrPairs,6), translateDocumentTitle() ]); }
async function translatePage(){ const btn=document.getElementById('translateBtn'); if(!isTranslated){ saveOriginalContent(); btn.innerHTML='<i data-feather="loader" style="vertical-align: -0.35em;"></i><span class="w3-margin-left download-text">TRADUCENDO...</span>'; btn.disabled=true; if(window.feather) feather.replace(); await translateToEnglish(); btn.innerHTML='<i data-feather="globe" style="vertical-align: -0.35em;"></i><span class="w3-margin-left download-text">VERSIONE ORIGINALE</span>'; btn.disabled=false; isTranslated=true; } else { restoreOriginalContent(); btn.innerHTML='<i data-feather="globe" style="vertical-align: -0.35em;"></i><span class="w3-margin-left download-text">TRADUCI PAGINA</span>'; isTranslated=false; if(typeof setAgeInHeading==='function') setAgeInHeading(); } if(window.feather) feather.replace(); }
function initRestrictions(){ document.body.addEventListener('cut',e=>e.preventDefault()); document.body.addEventListener('copy',e=>e.preventDefault()); document.body.addEventListener('contextmenu',e=>e.preventDefault()); }
function initFeather(){ if(window.feather){ feather.replace(); } else { setTimeout(initFeather,50); } }
document.addEventListener('DOMContentLoaded',()=>{ loadPersistentCache(); initRestrictions(); initFeather(); setAgeInHeading(); });
window.generatePDF=generatePDF; window.translatePage=translatePage; window.toggleNavigation=toggleNavigation;